# Mr Sleep v5.3 - Toggle Design Improvements PRD

**Version:** 5.3 (Build 8)
**Priority:** High
**Status:** Planning
**Created:** November 19, 2025
**Design Reference:** [Mr_Sleep_App_Design_Principles.md](./Mr_Sleep_App_Design_Principles.md)

---

## Executive Summary

This PRD outlines design improvements for the Sleep Now / Wake Up At mode toggle in Mr Sleep v5.3. The focus is on eliminating the visual mismatch between the toggle's background and the main page gradient, and adding a slick sliding animation with premium microinteractions to enhance the user experience.

---

## Design Principles Alignment

This PRD follows the established design principles documented in [Mr_Sleep_App_Design_Principles.md](./Mr_Sleep_App_Design_Principles.md). Key alignments:

### Color System
- **Golden yellow accent** (#E4BA4E) for the sliding pill indicator - matches "Primary action" color
- **Deep navy gradient** shows through transparent toggle - maintains visual cohesion
- **Light gray** for unselected text - follows "secondary or neutral" state logic

### Motion & Interaction Principles
> "Micro-interactions: Icon scaling... Smooth progress indicator transitions"
> "Animation curve: Ease-in-out to match the relaxing context"

The sliding pill animation uses:
- Spring curves with damping for natural, relaxing motion
- Scale bounce for satisfying micro-interaction
- Glow pulse for visual feedback

### UX & Interaction Design
> "Each screen has one clear goal"
> "The app mimics a ritual experience â€” calming before sleep"

The toggle maintains:
- Simple binary choice (Sleep Now / Wake Up At)
- Premium feel that doesn't break the calming experience
- Clear visual feedback on selection

### Typography
> "Font: Rounded, friendly sans-serif type (similar to SF Pro Rounded)"

Toggle text uses:
- `.design(.rounded)` for SF Pro Rounded
- Semibold for selected, regular for unselected
- White/gray color hierarchy for clear distinction

---

## Problems Identified

### 1. Duplicate Gradient Backgrounds Causing Visual Mismatch
**Current Issue:** Multiple views have their own gradient backgrounds that layer on top of each other, creating visual inconsistency behind the toggle area.

**Duplicated Gradients Found:**

```swift
// SleepContainerView.swift:46-55 (MAIN - keep this one)
LinearGradient(
    gradient: Gradient(colors: [
        Color(red: 0.1, green: 0.25, blue: 0.5),
        Color(red: 0.06, green: 0.15, blue: 0.35),
        Color(red: 0.03, green: 0.08, blue: 0.2)
    ]),
    startPoint: .topLeading,
    endPoint: .bottomTrailing
)

// SingleAlarmView.swift:581-594 (DUPLICATE - remove)
LinearGradient(...) // Same colors

// WakeUpAtView.swift:87-98 (DUPLICATE - remove)
LinearGradient(...) // Same colors

// OnboardingView (SingleAlarmView.swift:1930-1942) - overlay, keep
// AlarmPermissionSheet (SingleAlarmView.swift:2203-2215) - overlay, keep
```

**Impact:**
- The VStack area containing the toggle shows a different gradient than expected
- Layered gradients don't align perfectly, creating subtle color mismatches
- Visual inconsistency breaks the cohesive design

### 2. No Sliding Animation
**Current Issue:** When switching modes, the golden indicator simply appears/disappears without sliding.

```swift
// Current implementation (SleepContainerView.swift:179-187)
.background(
    ZStack {
        if isSelected {
            RoundedRectangle(cornerRadius: 22)
                .fill(Color(red: 0.894, green: 0.729, blue: 0.306))
                .padding(2)
                // ... shadow
        }
    }
)
```

**Impact:**
- Feels abrupt and cheap
- No sense of spatial relationship between the two options
- Missing the premium "slide" interaction users expect from modern iOS apps

---

## Proposed Solutions

### Solution 1: Remove Duplicate Gradient Backgrounds

Keep only the main gradient in `SleepContainerView` and remove duplicate backgrounds from child views. Child views should be transparent.

**Files to Modify:**

**SingleAlarmView.swift (lines 581-594):**
Remove the gradient background, keep only the GeometryReader:
```swift
// BEFORE
var body: some View {
    GeometryReader { geometry in
        ZStack {
            // Background gradient - Exact same as SleepNowView
            LinearGradient(...) // âŒ REMOVE THIS
            .ignoresSafeArea(.container, edges: .all)

            // Content...
        }
    }
}

// AFTER
var body: some View {
    GeometryReader { geometry in
        ZStack {
            // No background - inherits from SleepContainerView âœ…

            // Content...
        }
    }
}
```

**WakeUpAtView.swift (lines 87-98):**
Remove the gradient background:
```swift
// BEFORE
var body: some View {
    ZStack {
        // Background gradient - SAME AS SLEEP NOW
        LinearGradient(...) // âŒ REMOVE THIS
        .ignoresSafeArea(.all)

        // Main content
        ScrollView(...) { ... }
    }
}

// AFTER
var body: some View {
    // No ZStack wrapper needed, gradient comes from SleepContainerView âœ…
    ScrollView(.vertical, showsIndicators: false) {
        // Content...
    }
}
```

**Keep These (Full-Screen Overlays):**
- `OnboardingView` - needs its own background as it covers the entire screen
- `AlarmPermissionSheet` - modal overlay with different dark background

### Solution 2: Sliding Pill Indicator

Create a single golden pill that slides between the two options using SwiftUI's `matchedGeometryEffect` or position-based animation.

**Implementation Approach:**
```swift
@Namespace private var animation
@State private var selectedMode: SleepMode = .sleepNow

var body: some View {
    HStack(spacing: 0) {
        ForEach([SleepMode.sleepNow, .wakeUpAt], id: \.self) { mode in
            Text(mode == .sleepNow ? "Sleep Now" : "Wake Up At")
                .background(
                    Group {
                        if selectedMode == mode {
                            RoundedRectangle(cornerRadius: 22)
                                .fill(Color(red: 0.894, green: 0.729, blue: 0.306))
                                .matchedGeometryEffect(id: "pill", in: animation)
                        }
                    }
                )
        }
    }
}
```

**Animation Curve:**
```swift
withAnimation(.spring(response: 0.4, dampingFraction: 0.7, blendDuration: 0.1)) {
    selectedMode = newMode
}
```
- `response: 0.4` - slightly slower for visibility
- `dampingFraction: 0.7` - slight overshoot for "slick" feel
- Creates that premium iOS Control Center toggle feel

### Solution 3: Microinteractions

#### A. Scale Bounce on Selection
Selected option subtly scales up and settles:
```swift
@State private var selectedScale: CGFloat = 1.0

// On selection:
withAnimation(.spring(response: 0.3, dampingFraction: 0.5)) {
    selectedScale = 1.08
}
DispatchQueue.main.asyncAfter(deadline: .now() + 0.15) {
    withAnimation(.spring(response: 0.25, dampingFraction: 0.8)) {
        selectedScale = 1.0
    }
}
```

#### B. Text Color/Weight Transitions
Stagger the text animation slightly behind the pill:
```swift
Text(title)
    .font(.system(size: 17, weight: isSelected ? .semibold : .regular, design: .rounded))
    .foregroundColor(isSelected ? .white : Color(red: 0.6, green: 0.6, blue: 0.65))
    .animation(.easeOut(duration: 0.25).delay(0.05), value: isSelected)
```

#### C. Glow Pulse on Selection
Brief glow expansion when selected:
```swift
@State private var glowOpacity: Double = 0.0
@State private var glowScale: CGFloat = 1.0

// Selected pill background
RoundedRectangle(cornerRadius: 22)
    .fill(Color(red: 0.894, green: 0.729, blue: 0.306))
    .overlay(
        RoundedRectangle(cornerRadius: 22)
            .fill(Color(red: 0.894, green: 0.729, blue: 0.306))
            .scaleEffect(glowScale)
            .opacity(glowOpacity)
            .blur(radius: 8)
    )

// On selection:
glowOpacity = 0.6
glowScale = 1.15
withAnimation(.easeOut(duration: 0.3)) {
    glowOpacity = 0.0
    glowScale = 1.0
}
```

#### D. Haptic Refinement
Change from `.light` to `.soft` for more premium feel:
```swift
UIImpactFeedbackGenerator(style: .soft).impactOccurred()
```

#### E. Subtle Icon Bounce (Optional)
If there are icons in the toggle, add a slight rotation/bounce:
```swift
.rotationEffect(.degrees(isSelected ? 0 : -5))
.animation(.spring(response: 0.3, dampingFraction: 0.5), value: isSelected)
```

---

## Implementation Details

### Files to Modify

#### 1. Remove Duplicate Gradients

**SingleAlarmView.swift** - Remove lines 583-594:
```swift
// DELETE THIS BLOCK
LinearGradient(
    gradient: Gradient(colors: [
        Color(red: 0.1, green: 0.25, blue: 0.5),
        Color(red: 0.06, green: 0.15, blue: 0.35),
        Color(red: 0.03, green: 0.08, blue: 0.2)
    ]),
    startPoint: .topLeading,
    endPoint: .bottomTrailing
)
.ignoresSafeArea(.container, edges: .all)
```

**WakeUpAtView.swift** - Remove lines 87-98:
```swift
// DELETE THIS BLOCK (and simplify ZStack)
LinearGradient(
    gradient: Gradient(colors: [
        Color(red: 0.1, green: 0.25, blue: 0.5),
        Color(red: 0.06, green: 0.15, blue: 0.35),
        Color(red: 0.03, green: 0.08, blue: 0.2)
    ]),
    startPoint: .topLeading,
    endPoint: .bottomTrailing
)
.ignoresSafeArea(.all)
```

#### 2. Add Sliding Animation to Toggle

**SleepContainerView.swift** - Refactor ModeToggle component

### Complete Refactored ModeToggle Component

```swift
// MARK: - Mode Toggle Component

struct ModeToggle: View {
    @Binding var selectedMode: SleepMode
    @Namespace private var pillAnimation

    // Microinteraction states
    @State private var selectedScale: CGFloat = 1.0
    @State private var glowOpacity: Double = 0.0
    @State private var glowScale: CGFloat = 1.0

    @Environment(\.accessibilityReduceMotion) var reduceMotion

    var body: some View {
        HStack(spacing: 0) {
            // Sleep Now button
            toggleButton(
                title: "Sleep Now",
                mode: .sleepNow
            )

            // Wake Up At button
            toggleButton(
                title: "Wake Up At",
                mode: .wakeUpAt
            )
        }
        .frame(width: 320, height: 48)
        .background(
            // Frosted glass background
            RoundedRectangle(cornerRadius: 24)
                .fill(.ultraThinMaterial)
                .opacity(0.3)
        )
        .overlay(
            RoundedRectangle(cornerRadius: 24)
                .stroke(Color.white.opacity(0.12), lineWidth: 1)
        )
        .shadow(color: Color.black.opacity(0.2), radius: 8, x: 0, y: 4)
        .accessibilityElement(children: .contain)
        .accessibilityLabel("Sleep mode toggle")
        .accessibilityHint("Switch between Sleep Now and Wake Up At modes")
    }

    @ViewBuilder
    private func toggleButton(title: String, mode: SleepMode) -> some View {
        let isSelected = selectedMode == mode

        Button {
            if selectedMode != mode {
                selectMode(mode)
            }
        } label: {
            Text(title)
                .font(.system(size: 17, weight: isSelected ? .semibold : .regular, design: .rounded))
                .foregroundColor(isSelected ? .white : Color(red: 0.6, green: 0.6, blue: 0.65))
                .animation(.easeOut(duration: 0.2).delay(0.05), value: isSelected)
                .frame(maxWidth: .infinity, maxHeight: .infinity)
                .background(
                    ZStack {
                        if isSelected {
                            // Glow layer (behind pill)
                            RoundedRectangle(cornerRadius: 22)
                                .fill(Color(red: 0.894, green: 0.729, blue: 0.306))
                                .scaleEffect(glowScale)
                                .opacity(glowOpacity)
                                .blur(radius: 10)

                            // Main pill with sliding animation
                            RoundedRectangle(cornerRadius: 22)
                                .fill(Color(red: 0.894, green: 0.729, blue: 0.306))
                                .padding(3)
                                .shadow(color: Color(red: 0.894, green: 0.729, blue: 0.306).opacity(0.3), radius: 6, x: 0, y: 2)
                                .matchedGeometryEffect(id: "selectedPill", in: pillAnimation)
                                .scaleEffect(selectedScale)
                        }
                    }
                )
        }
        .buttonStyle(.plain)
        .accessibilityLabel(title)
        .accessibilityAddTraits(isSelected ? [.isButton, .isSelected] : .isButton)
        .accessibilityHint(isSelected ? "Currently selected" : "Double tap to select \(title) mode")
    }

    private func selectMode(_ mode: SleepMode) {
        // Haptic feedback - soft for premium feel
        UIImpactFeedbackGenerator(style: .soft).impactOccurred()

        if reduceMotion {
            selectedMode = mode
            return
        }

        // Trigger glow pulse
        glowOpacity = 0.5
        glowScale = 1.2

        // Animate pill slide with spring overshoot
        withAnimation(.spring(response: 0.4, dampingFraction: 0.7)) {
            selectedMode = mode
        }

        // Scale bounce microinteraction
        withAnimation(.spring(response: 0.3, dampingFraction: 0.5)) {
            selectedScale = 1.06
        }

        // Settle animations
        DispatchQueue.main.asyncAfter(deadline: .now() + 0.15) {
            withAnimation(.spring(response: 0.25, dampingFraction: 0.75)) {
                selectedScale = 1.0
            }
            withAnimation(.easeOut(duration: 0.25)) {
                glowOpacity = 0.0
                glowScale = 1.0
            }
        }
    }
}
```

### Remove ModeButton Component
The separate `ModeButton` struct can be deleted as the toggle logic is now integrated into `ModeToggle`.

---

## Animation Timing Summary

| Animation | Duration | Curve | Delay |
|-----------|----------|-------|-------|
| Pill slide | 0.4s | Spring (0.7 damping) | 0ms |
| Scale up | 0.3s | Spring (0.5 damping) | 0ms |
| Scale settle | 0.25s | Spring (0.75 damping) | 150ms |
| Glow fade | 0.25s | Ease out | 150ms |
| Text transition | 0.2s | Ease out | 50ms |

---

## Visual Reference

### Before (Current) - Layered Gradients
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SleepContainerView gradient                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  SingleAlarmView gradient (duplicate) â”‚  â”‚  â† Causes mismatch
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ [Sleep Now] [Wake Up At] toggle â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  Content...                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### After (Improved) - Single Gradient
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SleepContainerView gradient (only source)  â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚    â”‚ ğŸŸ¡[Sleep Now]   [Wake Up At]  â”‚        â”‚  â† Toggle
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚              â†‘                               â”‚
â”‚        Sliding golden pill                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚    â”‚ SingleAlarmView (transparent) â”‚        â”‚  â† No duplicate gradient
â”‚    â”‚ Content...                    â”‚        â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Testing Checklist

### Visual Tests
- [ ] No duplicate gradients - only SleepContainerView has background
- [ ] SingleAlarmView has transparent background
- [ ] WakeUpAtView has transparent background
- [ ] Toggle area blends seamlessly with main gradient
- [ ] Golden pill is clearly visible against background
- [ ] Text colors transition smoothly
- [ ] OnboardingView and AlarmPermissionSheet still have their own backgrounds

### Animation Tests
- [ ] Pill slides smoothly between options
- [ ] Slide animation has slight overshoot (spring feel)
- [ ] Scale bounce triggers on selection
- [ ] Scale settles back to 1.0
- [ ] Glow pulse appears and fades
- [ ] Text weight/color animates with slight delay

### Interaction Tests
- [ ] Haptic feels premium (soft impact)
- [ ] Tapping same option does nothing (no redundant haptic)
- [ ] Fast switching still animates correctly
- [ ] Touch target is full button area (160x48pt each)

### Accessibility Tests
- [ ] Reduce Motion skips animations
- [ ] VoiceOver labels correct
- [ ] Selected trait applied correctly
- [ ] Hint text is helpful

### Performance Tests
- [ ] No dropped frames during animation
- [ ] No memory leaks from state changes
- [ ] Animation doesn't block user input

---

## Success Criteria

1. **Visual Cohesion**: Single gradient source eliminates mismatched backgrounds behind toggle
2. **Seamless Integration**: Toggle area blends perfectly with page gradient
3. **Premium Feel**: Sliding animation with overshoot creates iOS-native premium interaction
4. **Satisfying Feedback**: Scale bounce + glow + haptic creates a satisfying tap response
5. **Performance**: Animations run at 60fps with no jank
6. **Accessibility**: Respects user preferences and assistive technologies

---

## Version Bump

Update version to 5.3 (build 8):
- `MARKETING_VERSION = 5.2;` â†’ `5.3;`
- `CURRENT_PROJECT_VERSION = 7;` â†’ `8;`

---

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Frosted material too heavy on older devices | Performance | Test on iPhone 11, use opacity fallback |
| matchedGeometryEffect glitches | Visual bugs | Use manual offset animation as fallback |
| Animations feel "too much" | UX | Keep timing tight (under 0.5s total) |

---

## Future Considerations

- Add subtle particle effects on selection (sparkles)
- Consider adding icon to each option (moon/sun)
- Explore drag-to-switch gesture

---

**End of PRD**
